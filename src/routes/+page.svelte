<script lang="ts">
	import { goto } from '$app/navigation';
	import { page } from '$app/state';

	let { data } = $props();

	let Filters = $derived(page.url);

	function Filters_get(name: string) {
		return Filters.searchParams.get(name);
	}

	function Filters_update(el: HTMLInputElement | HTMLSelectElement) {
		const url = new URL(Filters);
		if (el.value !== '') url.searchParams.set(el.name, el.value);
		else url.searchParams.delete(el.name);

		goto(url, { keepFocus: true });
	}

	function Filters_clear(...params: string[]) {
		const url = new URL(Filters);
		params.forEach((p) => url.searchParams.delete(p));
		goto(url, { keepFocus: true });
	}

	function Filters_isFiltered(...params: string[]) {
		return params.length > 0 && params.some((p) => Filters.searchParams.has(p));
	}
</script>

<div class="filters">
	{#snippet clearFilters(params: string[])}
		{#if Filters_isFiltered(...params)}
			<button onclick={() => Filters_clear(...params)}>❌</button>
		{/if}
	{/snippet}

	<div>Category:</div>
	<div>
		<select name="category" oninput={(e) => Filters_update(e.currentTarget)}>
			<option value="">&lt;All&gt;</option>
			{#each data.categories as category}
				<option value={category.id} selected={Filters_get('category') === category.id.toString()}>
					{category.name}
				</option>
			{/each}
		</select>
	</div>

	<div>Amount:</div>
	<div>
		<span
			>Min <input
				name="min"
				type="number"
				value={Filters_get('min')}
				oninput={(e) => Filters_update(e.currentTarget)}
			/></span
		>
		<span
			>Max <input
				name="max"
				type="number"
				value={Filters_get('max')}
				oninput={(e) => Filters_update(e.currentTarget)}
			/></span
		>
		{@render clearFilters(['min', 'max'])}
	</div>

	<div>Date range:</div>
	<div>
		<span
			>From <input
				name="from"
				type="date"
				value={Filters_get('from')}
				oninput={(e) => Filters_update(e.currentTarget)}
			/></span
		>
		<span
			>to <input
				name="to"
				type="date"
				value={Filters_get('to')}
				oninput={(e) => Filters_update(e.currentTarget)}
			/></span
		>
		{@render clearFilters(['from', 'to'])}
	</div>
</div>

<table>
	<thead>
		<tr>
			<th scope="col">Date</th>
			<th scope="col">Amount</th>
			<th scope="col">Category</th>
		</tr>
	</thead>
	<tbody>
		{#each data.transactions as t}
			<tr>
				<td>{t.date.toISOString().slice(0, 10)}</td>
				<td>{t.amount.toFixed(2)}</td>
				<td>{data.categories.find((c) => c.id === t.category)?.name}</td>
			</tr>
		{/each}
	</tbody>
</table>

<hr />
<p>
	💥 <a target="_blank" href="https://superforms.rocks">Created with Superforms for SvelteKit</a> 💥
</p>

<style>
	.filters button {
		padding: 0;
		background-color: transparent;
		border: none;
	}

	.filters {
		display: grid;
		column-gap: 2rem;
		grid-template-columns: minmax(min-content, 100px) 1fr;
		align-items: baseline;
	}

	.filters input[type='number'] {
		max-width: 100px;
	}

	table {
		margin-top: 2rem;
	}

	thead {
		background-color: #eee;
	}

	a {
		text-decoration: underline;
	}

	hr {
		margin-top: 4rem;
	}
</style>
